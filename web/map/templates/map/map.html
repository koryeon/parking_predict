{% extends "base.html" %}
{% block title %}ì„œìš¸ì‹œ ì£¼ì°¨ì¥ ì§€ë„{% endblock %}

{% block extra_style %}
    <style>
        .main-container {
            max-width: 760px;
            margin: 36px auto 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(30,41,59,0.09);
            padding: 36px 32px 32px 32px;
            text-align: center;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.7rem;
            color: #1e293b;
            font-weight: 700;
            letter-spacing: -1px;
        }
        #map {
            width: 100%;
            max-width: 700px;
            height: 420px;
            margin: 0 auto 20px auto;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(30,41,59,0.05);
        }
        #my-location {
            margin: 26px auto 32px auto;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 32px;
            box-shadow: 0 8px 32px rgba(56,189,248,0.15), 0 2px 8px rgba(30,41,59,0.08);
            border: 2px solid #38bdf8;
            max-width: 480px;
            letter-spacing: 0.01em;
            font-family: 'Noto Sans KR', Arial, sans-serif;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        #my-location::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #38bdf8, #0ea5e9, #06b6d4);
            border-radius: 16px;
            z-index: -1;
            opacity: 0.1;
        }
        #my-location:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(56,189,248,0.2), 0 4px 12px rgba(30,41,59,0.1);
        }
        .location-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .loc-icon {
            font-size: 1.5em;
            margin-right: 8px;
            color: #38bdf8;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .loc-title {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.2rem;
            margin: 0;
        }
        .loc-address {
            font-size: 1.1rem;
            color: #374151;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            line-height: 1.4;
        }
        .loc-coord {
            font-size: 0.95em;
            color: #64748b;
            font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
            background: rgba(241, 245, 249, 0.8);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 4px;
            letter-spacing: 0.02em;
            border: 1px solid #e2e8f0;
            backdrop-filter: blur(4px);
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #38bdf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #parking-list {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(30,41,59,0.04);
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px 4px;
            font-size: 14px;
        }
        th {
            background: #e0e7ef;
            color: #374151;
            font-weight: 600;
        }
        tr.highlight {
            background: #ffe082;
        }
        tr:hover {
            background: #e0f2fe;
        }
        @media (max-width: 800px) {
            .main-container, #parking-list, #map { max-width: 100%; padding: 12px; }
        }
        @media (max-width: 600px) {
            .main-container { padding: 10px 2vw; }
            #map { height: 320px; }
            #my-location {
                max-width: 90%;
                padding: 20px 24px;
            }
            .loc-address {
                font-size: 1rem;
            }
            .loc-coord {
                font-size: 0.9em;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="main-container">
        <h1>ì„œìš¸ì‹œ ì£¼ì°¨ì¥ ìœ„ì¹˜ ì•ˆë‚´</h1>
        <div id="map"></div>
        <div id="my-location">
            <div class="location-header">
                <span class="loc-icon">ğŸ“</span>
                <h3 class="loc-title">ë‚´ ìœ„ì¹˜</h3>
            </div>
            <div class="loc-address">
                <span class="loading-spinner"></span>
                ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <div class="loc-coord" style="display: none;"></div>
        </div>
        <div id="parking-list"></div>
    </div>
    <script type="text/javascript">
    const KAKAO_JS_KEY = "{{ kakao_js_key }}";
</script>
    <!-- ìˆ˜ì •: Django í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš© -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key|safe }}&libraries=services&autoload=false"></script>
    <script>
      const KAKAO_API_KEY = '{{ kakao_js_key }}';
      
      kakao.maps.load(function() {
        var container = document.getElementById('map');
        var options = {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 7
        };
        var map = new kakao.maps.Map(container, options);

        // Djangoì—ì„œ ë„˜ê¸´ ì£¼ì°¨ì¥ ë°ì´í„°
        var positions = [
          {% for p in parking_list %}
          {
            lat: {{ p.lat }},
            lng: {{ p.lng }},
            name: "{{ p.name }}",
            addr: "{{ p.addr }}",
            now_cnt: "{{ p.now_cnt }}",
            total_cnt: "{{ p.total_cnt }}"
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];

        // ì§€ë„ì— ì£¼ì°¨ì¥ ë§ˆì»¤ í‘œì‹œ
        var markers = [];
        positions.forEach(function(pos) {
          var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(pos.lat, pos.lng),
            title: pos.name
          });
          var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:13px;">
                        <b>${pos.name}</b><br>
                        ì£¼ì†Œ: ${pos.addr}<br>
                        ì‹¤ì‹œê°„/ì´: ${pos.now_cnt} / ${pos.total_cnt}
                      </div>`
          });
          kakao.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
          });
          markers.push(marker);
        });

        // ê°œì„ ëœ ì£¼ì†Œ ë³€í™˜ í•¨ìˆ˜
        async function getAddressFromCoords(lat, lng) {
            // 1ì°¨ ì‹œë„: SDK ë°©ë²•
            try {
                if (kakao.maps.services) {
                    return await new Promise((resolve, reject) => {
                        var geocoder = new kakao.maps.services.Geocoder();
                        geocoder.coord2Address(lng, lat, function(result, status) {
                            if (status === kakao.maps.services.Status.OK) {
                                var addr = result[0].address;
                                var fullAddress = addr.region_1depth_name + ' ' + 
                                                addr.region_2depth_name + ' ' + 
                                                addr.region_3depth_name;
                                resolve(fullAddress);
                            } else {
                                reject('SDK ë³€í™˜ ì‹¤íŒ¨');
                            }
                        });
                    });
                } else {
                    throw new Error('services ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ');
                }
            } catch (error) {
                console.log('SDK ë°©ë²• ì‹¤íŒ¨, REST API ì‹œë„');
                
                // 2ì°¨ ì‹œë„: REST API ë°©ë²•
                try {
                    const response = await fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lng}&y=${lat}`, {
                        headers: {
                            'Authorization': `KakaoAK ${KAKAO_API_KEY}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.documents && data.documents.length > 0) {
                        const addr = data.documents[0].address;
                        return addr.region_1depth_name + ' ' + 
                               addr.region_2depth_name + ' ' + 
                               addr.region_3depth_name;
                    } else {
                        throw new Error('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (restError) {
                    console.error('REST APIë„ ì‹¤íŒ¨:', restError);
                    throw new Error('ëª¨ë“  ì£¼ì†Œ ë³€í™˜ ë°©ë²• ì‹¤íŒ¨');
                }
            }
        }

        // ë‚´ ìœ„ì¹˜ ë°›ì•„ì˜¤ê¸° ë° ê°€ê¹Œìš´ ì£¼ì°¨ì¥ ê³„ì‚°
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(async function(position) {
            var myLat = position.coords.latitude;
            var myLng = position.coords.longitude;
            
            try {
                // ì£¼ì†Œ ë³€í™˜
                const address = await getAddressFromCoords(myLat, myLng);
                
                // HTML ì—…ë°ì´íŠ¸
                document.querySelector('.loc-address').innerHTML = address;
                document.querySelector('.loc-coord').innerHTML = 
                    `(${myLat.toFixed(6)}, ${myLng.toFixed(6)})`;
                document.querySelector('.loc-coord').style.display = 'block';
                
            } catch (error) {
                document.querySelector('.loc-address').innerHTML = 
                    'ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                document.querySelector('.loc-coord').innerHTML = 
                    `(${myLat.toFixed(6)}, ${myLng.toFixed(6)})`;
                document.querySelector('.loc-coord').style.display = 'block';
            }

            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
            var myMarker = new kakao.maps.Marker({
              map: map,
              position: new kakao.maps.LatLng(myLat, myLng),
              image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                new kakao.maps.Size(24, 35)
              )
            });
            map.setCenter(new kakao.maps.LatLng(myLat, myLng));

            // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (í•˜ë²„ì‚¬ì¸ ê³µì‹)
            function getDistance(lat1, lng1, lat2, lng2) {
              function toRad(x) { return x * Math.PI / 180; }
              var R = 6371; // km
              var dLat = toRad(lat2 - lat1);
              var dLng = toRad(lng2 - lng1);
              var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              return R * c;
            }

            // ê° ì£¼ì°¨ì¥ê³¼ ë‚´ ìœ„ì¹˜ ê±°ë¦¬ ê³„ì‚°
            positions.forEach(function(pos) {
              pos.distance = getDistance(myLat, myLng, pos.lat, pos.lng);
            });

            // ê°€ê¹Œìš´ ìˆœ ì •ë ¬ í›„ 10ê°œë§Œ ì¶”ë¦¼
            var sorted = positions.slice().sort(function(a, b) {
              return a.distance - b.distance;
            }).slice(0, 10);

            // ì§€ë„ ë§ˆì»¤ì™€ ë¦¬ìŠ¤íŠ¸ ì—°ë™
            function focusMarker(idx) {
              var pos = sorted[idx];
              map.panTo(new kakao.maps.LatLng(pos.lat, pos.lng));
              kakao.maps.event.trigger(markers[positions.indexOf(pos)], 'click');
              // ë¦¬ìŠ¤íŠ¸ ê°•ì¡°
              var rows = document.querySelectorAll('#parking-list tr');
              rows.forEach(function(row){ row.classList.remove('highlight'); });
              rows[idx+1].classList.add('highlight');
            }

            // ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
            var html = '<table><tr><th>ìˆœìœ„</th><th>ì£¼ì°¨ì¥ëª…</th><th>ì£¼ì†Œ</th><th>ì‹¤ì‹œê°„/ì´</th><th>ê±°ë¦¬(km)</th></tr>';
            sorted.forEach(function(pos, i) {
              html += `<tr onclick="focusMarker(${i})" style="cursor:pointer;">
                        <td>${i+1}</td>
                        <td>${pos.name}</td>
                        <td>${pos.addr}</td>
                        <td>${pos.now_cnt} / ${pos.total_cnt}</td>
                        <td>${pos.distance.toFixed(2)}</td>
                      </tr>`;
            });
            html += '</table>';
            document.getElementById('parking-list').innerHTML = html;

            // focusMarker í•¨ìˆ˜ ì „ì—­ ë“±ë¡
            window.focusMarker = focusMarker;
          }, function() {
            document.querySelector('.loc-address').innerHTML = 
                'ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            document.querySelector('.loc-coord').style.display = 'none';
          });
        } else {
          document.querySelector('.loc-address').innerHTML = 
              'ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          document.querySelector('.loc-coord').style.display = 'none';
        }
      });
    </script>
{% endblock %}
