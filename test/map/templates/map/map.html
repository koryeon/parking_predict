{% extends "base.html" %}
{% block title %}ì„œìš¸ì‹œ ì£¼ì°¨ì¥ ì§€ë„{% endblock %}

{% block extra_style %}
    <style>
        .main-container {
            max-width: 760px;
            margin: 36px auto 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(30,41,59,0.09);
            padding: 36px 32px 32px 32px;
            text-align: center;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.7rem;
            color: #1e293b;
            font-weight: 700;
            letter-spacing: -1px;
        }
        #map {
            width: 100%;
            max-width: 700px;
            height: 420px;
            margin: 0 auto 20px auto;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(30,41,59,0.05);
        }
        #my-location {
            margin: 26px auto 32px auto;
            font-weight: 600;
            color: #1e293b;
            font-size: 1.12rem;
            background: #fff;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 28px;
            box-shadow: 0 6px 24px rgba(56,189,248,0.11), 0 1.5px 2.5px rgba(30,41,59,0.03);
            border: 1.8px solid #38bdf8;
            min-height: 46px;
            max-width: 360px;
            letter-spacing: 0.01em;
            gap: 12px;
            font-family: 'Noto Sans KR', Arial, sans-serif;
            transition: box-shadow 0.18s, border 0.18s;
        }
        #my-location .loc-icon {
            font-size: 1.35em;
            margin-right: 8px;
            color: #38bdf8;
            vertical-align: middle;
        }
        #my-location .loc-desc {
            font-weight: 500;
            color: #2563eb;
            margin-right: 6px;
            font-size: 1.04em;
        }
        #my-location .loc-coord {
            font-size: 0.99em;
            color: #64748b;
            font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
            background: #f1f5f9;
            border-radius: 6px;
            padding: 3px 7px;
            margin-left: 2px;
            letter-spacing: 0.01em;
        }
        #parking-list {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(30,41,59,0.04);
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px 4px;
            font-size: 14px;
        }
        th {
            background: #e0e7ef;
            color: #374151;
            font-weight: 600;
        }
        tr.highlight {
            background: #ffe082;
        }
        tr:hover {
            background: #e0f2fe;
        }
        @media (max-width: 800px) {
            .main-container, #parking-list, #map { max-width: 100%; padding: 12px; }
        }
        @media (max-width: 600px) {
            .main-container { padding: 10px 2vw; }
            #map { height: 320px; }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="main-container">
        <h1>ì„œìš¸ì‹œ ì£¼ì°¨ì¥ ìœ„ì¹˜ ì•ˆë‚´</h1>
        <div id="map"></div>
        <div id="my-location">
            <span class="loc-icon">ğŸ“</span>
            <span class="loc-desc">ë‚´ ìœ„ì¹˜</span>
            <span class="loc-coord">(ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...)</span>
        </div>
        <div id="parking-list"></div>
    </div>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=65270d3823671073a168995df3db274c&autoload=false"></script>
    <script>
      kakao.maps.load(function() {
        var container = document.getElementById('map');
        var options = {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 7
        };
        var map = new kakao.maps.Map(container, options);

        // Djangoì—ì„œ ë„˜ê¸´ ì£¼ì°¨ì¥ ë°ì´í„°
        var positions = [
          {% for p in parking_list %}
          {
            lat: {{ p.lat }},
            lng: {{ p.lng }},
            name: "{{ p.name }}",
            addr: "{{ p.addr }}",
            now_cnt: "{{ p.now_cnt }}",
            total_cnt: "{{ p.total_cnt }}"
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];

        // ì§€ë„ì— ì£¼ì°¨ì¥ ë§ˆì»¤ í‘œì‹œ
        var markers = [];
        positions.forEach(function(pos) {
          var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(pos.lat, pos.lng),
            title: pos.name
          });
          var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:13px;">
                        <b>${pos.name}</b><br>
                        ì£¼ì†Œ: ${pos.addr}<br>
                        ì‹¤ì‹œê°„/ì´: ${pos.now_cnt} / ${pos.total_cnt}
                      </div>`
          });
          kakao.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
          });
          markers.push(marker);
        });

        // ë‚´ ìœ„ì¹˜ ë°›ì•„ì˜¤ê¸° ë° ê°€ê¹Œìš´ ì£¼ì°¨ì¥ ê³„ì‚°
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var myLat = position.coords.latitude;
            var myLng = position.coords.longitude;
            document.getElementById('my-location').innerText =
              'ë‚´ ìœ„ì¹˜: (' + myLat.toFixed(6) + ', ' + myLng.toFixed(6) + ')';

            // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
            var myMarker = new kakao.maps.Marker({
              map: map,
              position: new kakao.maps.LatLng(myLat, myLng),
              image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                new kakao.maps.Size(24, 35)
              )
            });
            map.setCenter(new kakao.maps.LatLng(myLat, myLng));

            // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (í•˜ë²„ì‚¬ì¸ ê³µì‹)
            function getDistance(lat1, lng1, lat2, lng2) {
              function toRad(x) { return x * Math.PI / 180; }
              var R = 6371; // km
              var dLat = toRad(lat2 - lat1);
              var dLng = toRad(lng2 - lng1);
              var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              return R * c;
            }

            // ê° ì£¼ì°¨ì¥ê³¼ ë‚´ ìœ„ì¹˜ ê±°ë¦¬ ê³„ì‚°
            positions.forEach(function(pos) {
              pos.distance = getDistance(myLat, myLng, pos.lat, pos.lng);
            });

            // ê°€ê¹Œìš´ ìˆœ ì •ë ¬ í›„ 10ê°œë§Œ ì¶”ë¦¼
            var sorted = positions.slice().sort(function(a, b) {
              return a.distance - b.distance;
            }).slice(0, 10);

            // ì§€ë„ ë§ˆì»¤ì™€ ë¦¬ìŠ¤íŠ¸ ì—°ë™ (ì„ íƒ)
            // ì•„ë˜ ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì§€ë„ ì´ë™
            function focusMarker(idx) {
              var pos = sorted[idx];
              map.panTo(new kakao.maps.LatLng(pos.lat, pos.lng));
              kakao.maps.event.trigger(markers[positions.indexOf(pos)], 'click');
              // ë¦¬ìŠ¤íŠ¸ ê°•ì¡°
              var rows = document.querySelectorAll('#parking-list tr');
              rows.forEach(function(row){ row.classList.remove('highlight'); });
              rows[idx+1].classList.add('highlight');
            }

            // ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
            var html = '<table><tr><th>ìˆœìœ„</th><th>ì£¼ì°¨ì¥ëª…</th><th>ì£¼ì†Œ</th><th>ì‹¤ì‹œê°„/ì´</th><th>ê±°ë¦¬(km)</th></tr>';
            sorted.forEach(function(pos, i) {
              html += `<tr onclick="focusMarker(${i})" style="cursor:pointer;">
                        <td>${i+1}</td>
                        <td>${pos.name}</td>
                        <td>${pos.addr}</td>
                        <td>${pos.now_cnt} / ${pos.total_cnt}</td>
                        <td>${pos.distance.toFixed(2)}</td>
                      </tr>`;
            });
            html += '</table>';
            document.getElementById('parking-list').innerHTML = html;

            // focusMarker í•¨ìˆ˜ ì „ì—­ ë“±ë¡
            window.focusMarker = focusMarker;
          }, function() {
            document.getElementById('my-location').innerText =
              'ë‚´ ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          });
        } else {
          document.getElementById('my-location').innerText =
            'ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        }
      });
    </script>
{% endblock %}
