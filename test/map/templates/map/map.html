{% extends "base.html" %}
{% block title %}서울시 주차장 지도{% endblock %}

{% block extra_style %}
    <style>
        .main-container {
            max-width: 760px;
            margin: 36px auto 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(30,41,59,0.09);
            padding: 36px 32px 32px 32px;
            text-align: center;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 1.7rem;
            color: #1e293b;
            font-weight: 700;
            letter-spacing: -1px;
        }
        #map {
            width: 100%;
            max-width: 700px;
            height: 420px;
            margin: 0 auto 20px auto;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(30,41,59,0.05);
        }
        #my-location {
            margin: 26px auto 32px auto;
            font-weight: 600;
            color: #1e293b;
            font-size: 1.12rem;
            background: #fff;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px 28px;
            box-shadow: 0 6px 24px rgba(56,189,248,0.11), 0 1.5px 2.5px rgba(30,41,59,0.03);
            border: 1.8px solid #38bdf8;
            min-height: 46px;
            max-width: 360px;
            letter-spacing: 0.01em;
            gap: 12px;
            font-family: 'Noto Sans KR', Arial, sans-serif;
            transition: box-shadow 0.18s, border 0.18s;
        }
        #my-location .loc-icon {
            font-size: 1.35em;
            margin-right: 8px;
            color: #38bdf8;
            vertical-align: middle;
        }
        #my-location .loc-desc {
            font-weight: 500;
            color: #2563eb;
            margin-right: 6px;
            font-size: 1.04em;
        }
        #my-location .loc-coord {
            font-size: 0.99em;
            color: #64748b;
            font-family: 'Fira Mono', 'Menlo', 'Consolas', monospace;
            background: #f1f5f9;
            border-radius: 6px;
            padding: 3px 7px;
            margin-left: 2px;
            letter-spacing: 0.01em;
        }
        #parking-list {
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(30,41,59,0.04);
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px 4px;
            font-size: 14px;
        }
        th {
            background: #e0e7ef;
            color: #374151;
            font-weight: 600;
        }
        tr.highlight {
            background: #ffe082;
        }
        tr:hover {
            background: #e0f2fe;
        }
        @media (max-width: 800px) {
            .main-container, #parking-list, #map { max-width: 100%; padding: 12px; }
        }
        @media (max-width: 600px) {
            .main-container { padding: 10px 2vw; }
            #map { height: 320px; }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="main-container">
        <h1>서울시 주차장 위치 안내</h1>
        <div id="map"></div>
        <div id="my-location">
            <span class="loc-icon">📍</span>
            <span class="loc-desc">내 위치</span>
            <span class="loc-coord">(위치 정보를 불러오는 중...)</span>
        </div>
        <div id="parking-list"></div>
    </div>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=65270d3823671073a168995df3db274c&autoload=false"></script>
    <script>
      kakao.maps.load(function() {
        var container = document.getElementById('map');
        var options = {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 7
        };
        var map = new kakao.maps.Map(container, options);

        // Django에서 넘긴 주차장 데이터
        var positions = [
          {% for p in parking_list %}
          {
            lat: {{ p.lat }},
            lng: {{ p.lng }},
            name: "{{ p.name }}",
            addr: "{{ p.addr }}",
            now_cnt: "{{ p.now_cnt }}",
            total_cnt: "{{ p.total_cnt }}"
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];

        // 지도에 주차장 마커 표시
        var markers = [];
        positions.forEach(function(pos) {
          var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(pos.lat, pos.lng),
            title: pos.name
          });
          var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:13px;">
                        <b>${pos.name}</b><br>
                        주소: ${pos.addr}<br>
                        실시간/총: ${pos.now_cnt} / ${pos.total_cnt}
                      </div>`
          });
          kakao.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
          });
          markers.push(marker);
        });

        // 내 위치 받아오기 및 가까운 주차장 계산
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var myLat = position.coords.latitude;
            var myLng = position.coords.longitude;
            document.getElementById('my-location').innerText =
              '내 위치: (' + myLat.toFixed(6) + ', ' + myLng.toFixed(6) + ')';

            // 내 위치 마커 표시
            var myMarker = new kakao.maps.Marker({
              map: map,
              position: new kakao.maps.LatLng(myLat, myLng),
              image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                new kakao.maps.Size(24, 35)
              )
            });
            map.setCenter(new kakao.maps.LatLng(myLat, myLng));

            // 거리 계산 함수 (하버사인 공식)
            function getDistance(lat1, lng1, lat2, lng2) {
              function toRad(x) { return x * Math.PI / 180; }
              var R = 6371; // km
              var dLat = toRad(lat2 - lat1);
              var dLng = toRad(lng2 - lng1);
              var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              return R * c;
            }

            // 각 주차장과 내 위치 거리 계산
            positions.forEach(function(pos) {
              pos.distance = getDistance(myLat, myLng, pos.lat, pos.lng);
            });

            // 가까운 순 정렬 후 10개만 추림
            var sorted = positions.slice().sort(function(a, b) {
              return a.distance - b.distance;
            }).slice(0, 10);

            // 지도 마커와 리스트 연동 (선택)
            // 아래 리스트 클릭 시 해당 마커로 지도 이동
            function focusMarker(idx) {
              var pos = sorted[idx];
              map.panTo(new kakao.maps.LatLng(pos.lat, pos.lng));
              kakao.maps.event.trigger(markers[positions.indexOf(pos)], 'click');
              // 리스트 강조
              var rows = document.querySelectorAll('#parking-list tr');
              rows.forEach(function(row){ row.classList.remove('highlight'); });
              rows[idx+1].classList.add('highlight');
            }

            // 리스트 HTML 생성
            var html = '<table><tr><th>순위</th><th>주차장명</th><th>주소</th><th>실시간/총</th><th>거리(km)</th></tr>';
            sorted.forEach(function(pos, i) {
              html += `<tr onclick="focusMarker(${i})" style="cursor:pointer;">
                        <td>${i+1}</td>
                        <td>${pos.name}</td>
                        <td>${pos.addr}</td>
                        <td>${pos.now_cnt} / ${pos.total_cnt}</td>
                        <td>${pos.distance.toFixed(2)}</td>
                      </tr>`;
            });
            html += '</table>';
            document.getElementById('parking-list').innerHTML = html;

            // focusMarker 함수 전역 등록
            window.focusMarker = focusMarker;
          }, function() {
            document.getElementById('my-location').innerText =
              '내 위치 정보를 불러올 수 없습니다.';
          });
        } else {
          document.getElementById('my-location').innerText =
            '브라우저가 위치 정보를 지원하지 않습니다.';
        }
      });
    </script>
{% endblock %}
